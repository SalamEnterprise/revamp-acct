## üß≠ 1Ô∏è‚É£ Pipeline Overview
| Layer                    | Tables                                     | Purpose                                      | Data Origin                     |
| ------------------------ | ------------------------------------------ | -------------------------------------------- | ------------------------------- |
| **Transactional Source** | `txn_source`                               | Raw business events (premium, claim, refund) | Operational system              |
| **Journal Staging**      | `je_header_staging`, `je_line_staging`     | Pre-posted journals (generated by Polars)    | Accounting engine               |
| **Journal Control**      | `je_batch_control`                         | Metadata for each posting batch              | Created when staging finishes   |
| **Ledger Core**          | `ledger_entry_header`, `ledger_entry_line` | Posted journals (immutable)                  | From staging after verification |
| **Ledger Balances**      | `account_balance_snapshot`                 | Aggregated balances per account/fund/period  | Derived from posted lines       |

## üß± 2Ô∏è‚É£ Posting Process: Staging ‚Üí Ledger
### Step 1: Validation
* Ensure double-entry rule: total DR = total CR per je_internal_id.
* Ensure all accounts and funds exist in dimension tables.
* Lock posting batch via je_batch_control:
* run_id
* total_headers
* total_lines
* hash_checksum
* created_at, created_by
* Step 2: Posting
* Copy staged journals to permanent ledger tables:
* ledger_entry_header (PK = je_id, unique je_number)
* ledger_entry_line (FK = je_id)
* Append-only (no updates).
### Step 3: Balances Update
* Aggregate to account_balance_snapshot:
* Group by (account_code, fund_code, period)
* Compute opening_balance, debit, credit, closing_balance
### Step 4: Audit Trail Completion
* Mark je_header_staging and je_line_staging as posted = TRUE and store posted_at.
* Retain run_id linkage across all layers.

## üß≠ Structure Overview

| Layer                    | Tables                                         | Function                                                                                  |
| ------------------------ | ---------------------------------------------- | ----------------------------------------------------------------------------------------- |
| **Source (Business)**    | `txn_source`                                   | Raw operational transactions from upstream (policy admin, claims, billing)                |
| **Accounting (Staging)** | `je_header`, `je_line`                         | Generated journals ‚Äî each header summarizing one business event, each line a debit/credit |
| **Dimensions**           | `chart_of_accounts`, `fund_dim`, `product_dim` | Reference structures for reporting, validation, and financial statement mapping           |

## üß† 4Ô∏è‚É£ Data Lineage
| From                                             | To                                    | Key                               | Purpose |
| ------------------------------------------------ | ------------------------------------- | --------------------------------- | ------- |
| `txn_source` ‚Üí `je_header_staging`               | `source_rowid`                        | Trace transaction origin          |         |
| `je_header_staging` ‚Üí `ledger_entry_header`      | `je_number`, `run_id`                 | Transition from staging to posted |         |
| `je_line_staging` ‚Üí `ledger_entry_line`          | `je_internal_id` ‚Üí `je_id`            | Maintain line-level trace         |         |
| `ledger_entry_line` ‚Üí `account_balance_snapshot` | `account_code`, `fund_code`, `period` | Summarize financial position      |         |

## üß© 5Ô∏è‚É£ Posting Control Logic (conceptual)
| Phase                   | Action                              | Validation                  |
| ----------------------- | ----------------------------------- | --------------------------- |
| **Pre-check**           | Verify DR = CR                      | Reject if imbalance         |
| **Batch registration**  | Create entry in `je_batch_control`  | Store checksum              |
| **Posting**             | Insert into `ledger_entry_*` tables | Ensure unique `je_number`   |
| **Balance aggregation** | Update/insert snapshots             | Consistency by fund/account |
| **Finalize**            | Mark batch as POSTED                | Write `posted_at` timestamp |


## üßÆ Data Lineage Summary
| Trace Path                                              | Description                | Typical Use                     |
| ------------------------------------------------------- | -------------------------- | ------------------------------- |
| `txn_source.source_rowid ‚Üí je_header.source_rowid`      | Business ‚Üí Journal trace   | Transaction-to-accounting audit |
| `je_header.je_internal_id ‚Üí je_line.je_internal_id`     | Header ‚Üí Lines             | Ledger reconstruction           |
| `je_line.account_code ‚Üí chart_of_accounts.account_code` | Line ‚Üí Chart of Accounts   | Financial statement rollup      |
| `je_line.fund_code ‚Üí fund_dim.fund_code`                | Line ‚Üí Fund                | Takaful fund segregation        |
| `je_header.product_code ‚Üí product_dim.product_code`     | Header ‚Üí Product dimension | Product-level profitability     |

## üßæ Reporting Hierarchy (simplified)
### Trial Balance
```text
CHART_OF_ACCOUNTS
    ‚Üë
JE_LINE  ‚Üê  JE_HEADER  ‚Üê  TXN_SOURCE
```

### Fund Statement (Takaful)
```text
FUND_DIM
    ‚Üë
JE_LINE (fund movements)
```
### Product P&L
```text
PRODUCT_DIM
    ‚Üë
JE_HEADER + JE_LINE (aggregated by product_code)

```

### üß† Audit Flow Example
#### Operational control
1. Trace a specific premium receipt:
  ```sql
  SELECT * FROM txn_source WHERE source_rowid='TXN-0001234';
SELECT * FROM je_header WHERE source_rowid='TXN-0001234';
SELECT * FROM je_line WHERE source_rowid='TXN-0001234';
```
#### Accounting reconstruction
   To rebuild the ledger for October 2025:
   ```sql
   SELECT account_code, SUM(CASE WHEN side='DR' THEN amount ELSE -amount END)
   FROM je_line
   WHERE je_date BETWEEN '2025-10-01' AND '2025-10-31'GROUP BY account_code;
   ```
#### Fund segregation
Verify Tabarru / Tanahud / Operator movements:
```sql
SELECT fund_code, SUM(amount) FROM je_line GROUP BY fund_code;

```

üßæ 6Ô∏è‚É£ Example Audit Queries

Find all JEs from one batch:
```sql
SELECT je_number, je_date FROM ledger_entry_header WHERE run_id = '...';
```

Trace back to transaction source:
```
SELECT t.*, h.je_number, h.run_id
FROM txn_source t
JOIN ledger_entry_header h ON t.source_rowid = h.source_rowid
WHERE h.je_number = '20251003-JEA-000000123';
```

Reconcile fund balances (Takaful view):
```sql
SELECT fund_code, SUM(CASE WHEN side='DR' THEN amount ELSE -amount END) AS net_movement
FROM ledger_entry_line
WHERE je_date BETWEEN '2025-10-01' AND '2025-10-31'
GROUP BY fund_code;
```

### Complete logical structure and audit trail relationships between txn_source, je_header, and je_line

![ER Diagram](er_diagram.png)

### Data flow diagram
```mermaid
flowchart TD
    %% =====================
    %% SOURCE LAYER
    %% =====================
    subgraph "1. Source System"
        A1[("txn_source<br>(raw transactions)<br>premium receipts, claims, etc.")]
    end

    %% =====================
    %% BACKEND ENGINE (Polars)
    %% =====================
    subgraph "2. Backend Application (Python + Polars)"
        B1["fund allocation + product/channel tagging<br>(vectorized in Polars)"]
        B2["journal expansion<br>(template lookup & DR/CR mapping)"]
        B3["validation<br>(balance check, account/fund existence, tolerance)"]
    end

    %% =====================
    %% STAGING LAYER
    %% =====================
    subgraph "3. Database Staging (PostgreSQL - UNLOGGED)"
        S1[("je_header_staging")]
        S2[("je_line_staging")]
        S3[("validation logs + batch control")]
    end

    %% =====================
    %% LEDGER
    %% =====================
    subgraph "4. Official Ledger (PostgreSQL - Partitioned)"
        L1[("ledger_entry_header<br>(immutable journal headers)")]
        L2[("ledger_entry_line<br>(partitioned by month je_date)")]
        L3[("account_balance_snapshot<br>(monthly roll-forward)")]
    end

    %% =====================
    %% REPORTING
    %% =====================
    subgraph "5. Reporting & Analytics"
        R1[("mv_trial_balance_month<br>(materialized view)")]
        R2[("v_product_channel_month<br>(view for P&L slice)")]
        R3[/"financial statements<br>Balance Sheet / P&L / Fund Statement"/]
    end

    %% =====================
    %% GOVERNANCE & AUDIT
    %% =====================
    subgraph "6. Governance & Audit Trail"
        G1["Batch Control (run_id, checksum, operator, status)"]
        G2["Reconciliation Dashboard"]
        G3["Data Lineage: source_rowid ‚Üî JE ‚Üî Ledger ‚Üî Report"]
    end

    %% =====================
    %% MAIN DATA FLOW
    %% =====================
    A1 ==>|load via COPY| B1
    B1 ==> B2
    B2 ==> B3
    B3 ==> S1 & S2 & S3
    
    S1 & S2 ==>|validation pass| L1 & L2
    L1 & L2 ==> L3
    
    L1 & L2 ==> R1 & R2
    R1 & R2 ==> R3

    %% =====================
    %% AUDIT FLOW
    %% =====================
    S1 & S2 & S3 -.-> G1
    S1 & S2 -.-> G2
    A1 -.-> G3
    S1 & S2 -.-> G3
    L1 & L2 -.-> G3
    R3 -.-> G3
```
   
    R3 --> G3
```
