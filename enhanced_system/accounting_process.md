## üß≠ 1Ô∏è‚É£ Pipeline Overview
| Layer                    | Tables                                     | Purpose                                      | Data Origin                     |
| ------------------------ | ------------------------------------------ | -------------------------------------------- | ------------------------------- |
| **Transactional Source** | `txn_source`                               | Raw business events (premium, claim, refund) | Operational system              |
| **Journal Staging**      | `je_header_staging`, `je_line_staging`     | Pre-posted journals (generated by Polars)    | Accounting engine               |
| **Journal Control**      | `je_batch_control`                         | Metadata for each posting batch              | Created when staging finishes   |
| **Ledger Core**          | `ledger_entry_header`, `ledger_entry_line` | Posted journals (immutable)                  | From staging after verification |
| **Ledger Balances**      | `account_balance_snapshot`                 | Aggregated balances per account/fund/period  | Derived from posted lines       |

## üß± 2Ô∏è‚É£ Posting Process: Staging ‚Üí Ledger
### Step 1: Validation
* Ensure double-entry rule: total DR = total CR per je_internal_id.
* Ensure all accounts and funds exist in dimension tables.
* Lock posting batch via je_batch_control:
* run_id
* total_headers
* total_lines
* hash_checksum
* created_at, created_by
* Step 2: Posting
* Copy staged journals to permanent ledger tables:
* ledger_entry_header (PK = je_id, unique je_number)
* ledger_entry_line (FK = je_id)
* Append-only (no updates).
### Step 3: Balances Update
* Aggregate to account_balance_snapshot:
* Group by (account_code, fund_code, period)
* Compute opening_balance, debit, credit, closing_balance
### Step 4: Audit Trail Completion
* Mark je_header_staging and je_line_staging as posted = TRUE and store posted_at.
* Retain run_id linkage across all layers.

## üß≠ Structure Overview

| Layer                    | Tables                                         | Function                                                                                  |
| ------------------------ | ---------------------------------------------- | ----------------------------------------------------------------------------------------- |
| **Source (Business)**    | `txn_source`                                   | Raw operational transactions from upstream (policy admin, claims, billing)                |
| **Accounting (Staging)** | `je_header`, `je_line`                         | Generated journals ‚Äî each header summarizing one business event, each line a debit/credit |
| **Dimensions**           | `chart_of_accounts`, `fund_dim`, `product_dim` | Reference structures for reporting, validation, and financial statement mapping           |

## üß† 4Ô∏è‚É£ Data Lineage
| From                                             | To                                    | Key                               | Purpose |
| ------------------------------------------------ | ------------------------------------- | --------------------------------- | ------- |
| `txn_source` ‚Üí `je_header_staging`               | `source_rowid`                        | Trace transaction origin          |         |
| `je_header_staging` ‚Üí `ledger_entry_header`      | `je_number`, `run_id`                 | Transition from staging to posted |         |
| `je_line_staging` ‚Üí `ledger_entry_line`          | `je_internal_id` ‚Üí `je_id`            | Maintain line-level trace         |         |
| `ledger_entry_line` ‚Üí `account_balance_snapshot` | `account_code`, `fund_code`, `period` | Summarize financial position      |         |

## üß© 5Ô∏è‚É£ Posting Control Logic (conceptual)
| Phase                   | Action                              | Validation                  |
| ----------------------- | ----------------------------------- | --------------------------- |
| **Pre-check**           | Verify DR = CR                      | Reject if imbalance         |
| **Batch registration**  | Create entry in `je_batch_control`  | Store checksum              |
| **Posting**             | Insert into `ledger_entry_*` tables | Ensure unique `je_number`   |
| **Balance aggregation** | Update/insert snapshots             | Consistency by fund/account |
| **Finalize**            | Mark batch as POSTED                | Write `posted_at` timestamp |


## üßÆ Data Lineage Summary
| Trace Path                                              | Description                | Typical Use                     |
| ------------------------------------------------------- | -------------------------- | ------------------------------- |
| `txn_source.source_rowid ‚Üí je_header.source_rowid`      | Business ‚Üí Journal trace   | Transaction-to-accounting audit |
| `je_header.je_internal_id ‚Üí je_line.je_internal_id`     | Header ‚Üí Lines             | Ledger reconstruction           |
| `je_line.account_code ‚Üí chart_of_accounts.account_code` | Line ‚Üí Chart of Accounts   | Financial statement rollup      |
| `je_line.fund_code ‚Üí fund_dim.fund_code`                | Line ‚Üí Fund                | Takaful fund segregation        |
| `je_header.product_code ‚Üí product_dim.product_code`     | Header ‚Üí Product dimension | Product-level profitability     |

## üßæ Reporting Hierarchy (simplified)
### Trial Balance
```text
CHART_OF_ACCOUNTS
    ‚Üë
JE_LINE  ‚Üê  JE_HEADER  ‚Üê  TXN_SOURCE
```

### Fund Statement (Takaful)
```text
FUND_DIM
    ‚Üë
JE_LINE (fund movements)
```
### Product P&L
```text
PRODUCT_DIM
    ‚Üë
JE_HEADER + JE_LINE (aggregated by product_code)

```

### üß† Audit Flow Example
#### Operational control
1. Trace a specific premium receipt:
  ```sql
  SELECT * FROM txn_source WHERE source_rowid='TXN-0001234';
SELECT * FROM je_header WHERE source_rowid='TXN-0001234';
SELECT * FROM je_line WHERE source_rowid='TXN-0001234';
```
#### Accounting reconstruction
   To rebuild the ledger for October 2025:
   ```sql
   SELECT account_code, SUM(CASE WHEN side='DR' THEN amount ELSE -amount END)
   FROM je_line
   WHERE je_date BETWEEN '2025-10-01' AND '2025-10-31'GROUP BY account_code;
   ```
#### Fund segregation
Verify Tabarru / Tanahud / Operator movements:
```sql
SELECT fund_code, SUM(amount) FROM je_line GROUP BY fund_code;

```

üßæ 6Ô∏è‚É£ Example Audit Queries

Find all JEs from one batch:
```sql
SELECT je_number, je_date FROM ledger_entry_header WHERE run_id = '...';
```

Trace back to transaction source:
```
SELECT t.*, h.je_number, h.run_id
FROM txn_source t
JOIN ledger_entry_header h ON t.source_rowid = h.source_rowid
WHERE h.je_number = '20251003-JEA-000000123';
```

Reconcile fund balances (Takaful view):
```sql
SELECT fund_code, SUM(CASE WHEN side='DR' THEN amount ELSE -amount END) AS net_movement
FROM ledger_entry_line
WHERE je_date BETWEEN '2025-10-01' AND '2025-10-31'
GROUP BY fund_code;
```

### Complete logical structure and audit trail relationships between txn_source, je_header, and je_line

![ER Diagram](er_diagram.png)

### Data flow diagram
```mermaid
flowchart TD
    %% =====================
    %% SOURCE LAYER
    %% =====================
    subgraph "1. Source System"
        A1[("txn_source<br>(raw transactions)<br>premium receipts, claims, etc.")]
    end

    %% =====================
    %% BACKEND ENGINE (Polars)
    %% =====================
    subgraph "2. Backend Application (Python + Polars)"
        B1["fund allocation + product/channel tagging<br>(vectorized in Polars)"]
        B2["journal expansion<br>(template lookup & DR/CR mapping)"]
        B3["validation<br>(balance check, account/fund existence, tolerance)"]
    end

    %% =====================
    %% STAGING LAYER
    %% =====================
    subgraph "3. Database Staging (PostgreSQL - UNLOGGED)"
        S1[("je_header_staging")]
        S2[("je_line_staging")]
        S3[("validation logs + batch control")]
    end

    %% =====================
    %% LEDGER
    %% =====================
    subgraph "4. Official Ledger (PostgreSQL - Partitioned)"
        L1[("ledger_entry_header<br>(immutable journal headers)")]
        L2[("ledger_entry_line<br>(partitioned by month je_date)")]
        L3[("account_balance_snapshot<br>(monthly roll-forward)")]
    end

    %% =====================
    %% REPORTING
    %% =====================
    subgraph "5. Reporting & Analytics"
        R1[("mv_trial_balance_month<br>(materialized view)")]
        R2[("v_product_channel_month<br>(view for P&L slice)")]
        R3[/"financial statements<br>Balance Sheet / P&L / Fund Statement"/]
    end

    %% =====================
    %% GOVERNANCE & AUDIT
    %% =====================
    subgraph "6. Governance & Audit Trail"
        G1["Batch Control (run_id, checksum, operator, status)"]
        G2["Reconciliation Dashboard"]
        G3["Data Lineage: source_rowid ‚Üî JE ‚Üî Ledger ‚Üî Report"]
    end

    %% =====================
    %% MAIN DATA FLOW
    %% =====================
    A1 ==>|load via COPY| B1
    B1 ==> B2
    B2 ==> B3
    B3 ==> S1 & S2 & S3
    
    S1 & S2 ==>|validation pass| L1 & L2
    L1 & L2 ==> L3
    
    L1 & L2 ==> R1 & R2
    R1 & R2 ==> R3

    %% =====================
    %% AUDIT FLOW
    %% =====================
    S1 & S2 & S3 -.-> G1
    S1 & S2 -.-> G2
    A1 -.-> G3
    S1 & S2 -.-> G3
    L1 & L2 -.-> G3
    R3 -.-> G3
```
### Operational Flow
```mermaid
sequenceDiagram
    autonumber
    %% =====================================================================
    %% SYSTEMS & ROLES
    %% =====================================================================
    participant SRC as Source System<br/>(Policy / Claim / Billing DB)
    participant APP as Backend Engine<br/>(Python + Polars)
    participant STG as Staging DB<br/>(je_header_staging / je_line_staging)
    participant LED as Ledger DB<br/>(ledger_entry_header / ledger_entry_line)
    participant BAL as Balances / Snapshots
    participant MV  as Materialized Views<br/>(Trial Balance, Fund, P&L)
    participant AUD as Audit & Control<br/>(Batch Control, Checksum, Logs)
    participant REP as Reporting Layer<br/>(BI / IFRS-17 Reports)

    %% =====================================================================
    %% DAILY CYCLE (OCT-2025 example)
    %% =====================================================================

    %% 1. EXTRACT & LOAD
    SRC->>APP: ‚ë† Export transactions (txn_source)<br/>e.g., Premium Receipts, Claims
    APP->>STG: ‚ë° COPY ‚Üí staging (raw load)
    note over STG: <b>Elapsed ‚âà 25 s</b><br/>UNLOGGED, high-speed import

    %% 2. EXPANSION & VALIDATION
    APP->>APP: ‚ë¢ Vectorized fund allocation<br/>& journal expansion (Polars)
    APP->>STG: ‚ë£ Write je_header_staging + je_line_staging
    APP->>AUD: ‚ë§ Register batch_control(run_id,status='PENDING')
    APP->>APP: ‚ë• Validation ‚Üí DR=CR, fund/account checks
    note over APP,STG: <b>Elapsed ‚âà 5 s</b><br/>Fast vectorized verification

    %% 3. POSTING WINDOW
    APP->>LED: ‚ë¶ COPY ‚Üí ledger_entry_header / line<br/>(partitioned by month)
    LED->>BAL: ‚ëß Update monthly account_balance_snapshot
    LED->>AUD: ‚ë® Mark batch_control(status='POSTED',checksum)
    note over LED: <b>Elapsed ‚âà 60 ‚Äì 70 s</b><br/>8 M lines committed

    %% 4. REPORTING REFRESH
    BAL->>MV: ‚ë© Refresh materialized views<br/>(trial balance, fund, P&L)
    MV->>REP: ‚ë™ Expose reports via API / dashboard
    note over MV: <b>Elapsed ‚âà 5 s</b><br/>Incremental refresh

    %% 5. GOVERNANCE TRAIL
    AUD->>REP: ‚ë´ Audit evidence: run_id, checksum, operator, timestamp
    REP->>AUD: ‚ë¨ Reconciliation logs & approvals
    note over AUD: Full lineage: txn_source ‚Üí JE ‚Üí Ledger ‚Üí Report

```

### Staging live cycle 
```mermaid
flowchart TD
    %% ======================================================
    %% STAGING LIFECYCLE MANAGEMENT DIAGRAM
    %% ======================================================

    subgraph LOAD["‚ë† LOAD - Ingestion Stage"]
        A1["Source System<br/>(txn_source)"]
        A2["Backend Engine (Python + Polars)<br/>fund allocation + journal expansion"]
        A3["je_header_staging / je_line_staging<br/><b>UNLOGGED</b> PostgreSQL tables"]
        A1 -->|"COPY / bulk insert"| A2
        A2 -->|"COPY to staging"| A3
        noteA["
            Row volume: 1‚Äì8M<br/>
            Index: run_id, je_internal_id<br/>
            Frequency: hourly / daily
        "] 
        A3 -.-> noteA
    end

    subgraph VALIDATE["‚ë° VALIDATION - QA & Integrity"]
        V1["DR=CR check per JE"]
        V2["Account + fund existence check"]
        V3["Run metadata validation (batch_control)"]
        A3 --> V1 --> V2 --> V3
        noteV["
            Vectorized Polars validation<br/>
            <b>Time: ~3‚Äì5 sec</b><br/>
            Status updated: PENDING ‚Üí VALIDATED
        "]
        V3 -.-> noteV
    end

    subgraph POST["‚ë¢ POSTING - Move to Ledger"]
        P1["COPY ‚Üí ledger_entry_header / line<br/>partitioned by month"]
        P2["Update account_balance_snapshot<br/>and trial balance"]
        V3 -->|"Validated run_id only"| P1 --> P2
        noteP["
            <b>Time: ~60‚Äì70 sec</b><br/>
            8M lines posted<br/>
            Immutability enforced
        "]
        P2 -.-> noteP
    end

    subgraph ARCHIVE["‚ë£ ARCHIVE - Retain evidence"]
        R1["Insert failed runs into<br/>je_line_staging_archive"]
        R2["Insert headers into<br/>je_header_staging_archive"]
        P2 --> R1
        P2 --> R2
        noteR["
            Keeps audit trail<br/>
            <b>Retention: 30‚Äì90 days</b><br/>
            Optional compression (ZSTD)
        "]
        R2 -.-> noteR
    end

    subgraph PURGE["‚ë§ PURGE - Cleanup"]
        X1["DELETE or TRUNCATE<br/>old staging partitions"]
        X2["VACUUM / ANALYZE"]
        R2 --> X1 --> X2
        noteX["
            <b>Frequency:</b> weekly or monthly<br/>
            <b>Goal:</b> keep staging small & fast
        "]
        X2 -.-> noteX
    end

    %% DATAFLOW CONNECTIONS
    LOAD --> VALIDATE
    VALIDATE --> POST
    POST --> ARCHIVE
    ARCHIVE --> PURGE

    %% Styling (optional for better visuals in GitHub)
    classDef stage fill:#f0f7ff,stroke:#0366d6,stroke-width:2px,color:#000;
    class LOAD,VALIDATE,POST,ARCHIVE,PURGE stage
    classDef note fill:#fff3cd,stroke:#856404,stroke-dasharray: 5 5,color:#856404,font-size:12px;
    class noteA,noteV,noteP,noteR,noteX note
```
